<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–í–æ—Ä–¥—Å—Ç–∞—Ç –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä PRO</title>
    <style>
      /*fonts */
      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-light.woff2") format("woff2"), url("fonts/text-light.woff") format("woff");
        font-weight: 300;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-light-italic.woff2") format("woff2"), url("fonts/text-light-italic.woff") format("woff");
        font-weight: 300;
        font-style: italic;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-regular.woff2") format("woff2"), url("fonts/text-regular.woff") format("woff");
        font-weight: 400;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-regular-italic.woff2") format("woff2"), url("fonts/text-regular-italic.woff") format("woff");
        font-weight: 400;
        font-style: italic;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-medium.woff2") format("woff2"), url("fonts/text-medium.woff") format("woff");
        font-weight: 500;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-medium-italic.woff2") format("woff2"), url("fonts/text-medium-italic.woff") format("woff");
        font-weight: 500;
        font-style: italic;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-bold.woff2") format("woff2"), url("fonts/text-bold.woff") format("woff");
        font-weight: 600;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Text";
        src: url("fonts/text-bold-italic.woff2") format("woff2"), url("fonts/text-bold-italic.woff") format("woff");
        font-weight: 600;
        font-style: italic;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-thin.woff2") format("woff2"), url("fonts/text-geo-thin.woff") format("woff");
        font-weight: 100;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-light.woff2") format("woff2"), url("fonts/text-geo-light.woff") format("woff");
        font-weight: 300;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-regular.woff2") format("woff2"), url("fonts/text-geo-regular.woff") format("woff");
        font-weight: 400;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-medium.woff2") format("woff2"), url("fonts/text-geo-medium.woff") format("woff");
        font-weight: 500;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-bold.woff2") format("woff2"), url("fonts/text-geo-bold.woff") format("woff");
        font-weight: 600;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }

      @font-face {
        font-family: "YS Geo";
        src: url("fonts/text-geo-black.woff2") format("woff2"), url("fonts/text-geo-black.woff") format("woff");
        font-weight: 900;
        font-style: normal;
        font-stretch: normal;
        font-display: swap;
      }
      :root {
        --primary: #0044cc;
        --primary-hover: #003399;
        --bg-body: #f4f6f9;
        --bg-card: #ffffff;
        --text-main: #333;
        --text-light: #666;
        --border: #e0e0e0;
        --danger: #d32f2f;
        --success: #2e7d32;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        --radius: 8px;
        --font-title: "YS Geo", Verdana, sans-serif;
        --font-text: "YS Text", Verdana, sans-serif;
      }
      html {
        font-size: 18px;
      }
      body {
        font-family: var(--font-text);
        background-color: var(--bg-body);
        color: var(--text-main);
        margin: 0;
        padding: 24px;
        font-size: 1rem;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        margin-bottom: 60px;
      }
      h1,
      h2,
      h3 {
        font-family: var(--font-title);
      }
      h1 {
        margin: 0;
        font-size: 2rem;
        color: var(--text-main);
      }
      .description {
        color: var(--text-light);
        font-size: 1rem;
        margin: 10px 0 30px;
      }

      .project-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .json-controls {
        display: flex;
        gap: 5px;
        margin-left: 20px;
        border-left: 1px solid #ccc;
        padding-left: 20px;
      }

      /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ */
      #currentProjectLabel {
        font-size: 0.8rem;
        font-weight: bold;
        color: var(--success);
        margin-right: 10px;
        display: none;
        background: #e8f5e9;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #c8e6c9;
      }

      .section-title {
        font-size: 1rem;
        font-weight: 700;
        margin: 30px 0 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .grid-wrapper {
        display: flex;
        gap: 20px;
        overflow-x: auto;
        padding-bottom: 15px;
        align-items: flex-start;
      }
      .card {
        background: var(--bg-card);
        border-radius: var(--radius);
        width: 300px;
        min-width: 300px;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow);
        border: 1px solid transparent;
        transition: border-color 0.2s;
      }
      .card:hover {
        border-color: #ccc;
      }
      .card-header {
        padding: 10px 12px;
        background: #f8f9fa;
        border-bottom: 1px solid var(--border);
        border-radius: var(--radius) var(--radius) 0 0;
      }
      .card-header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }
      .card-title {
        font-weight: 600;
        font-size: 1rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
      }
      .card-tools {
        display: flex;
        gap: 5px;
        align-items: center;
      }
      .list-select {
        max-width: 100px;
        font-size: 0.7rem;
        padding: 2px;
        border: 1px solid #ccc;
        border-radius: 4px;
        background: #fff;
        height: 24px;
        cursor: pointer;
      }
      .card-hint {
        font-size: 0.7rem;
        color: #777;
        line-height: 1.3;
      }
      .card-body {
        padding: 10px;
        flex-grow: 1;
      }
      textarea {
        width: 100%;
        height: 250px;
        border: 1px solid var(--border);
        border-radius: 4px;
        resize: vertical;
        padding: 8px;
        box-sizing: border-box;
        font-family: inherit;
        font-size: 1rem;
        outline: none;
      }
      textarea:focus {
        border-color: var(--primary);
      }
      .card-footer {
        padding: 5px 15px 10px;
        text-align: right;
        font-size: 0.7rem;
        color: var(--text-light);
      }
      .btn-icon {
        background: transparent;
        border: 1px solid #ddd;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: #555;
        transition: 0.2s;
      }
      .btn-icon:hover {
        background: #eee;
        color: #000;
      }
      .btn-add {
        background: var(--primary);
        color: white;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 50%;
      }
      .btn-add:hover {
        background: var(--primary-hover);
      }
      .btn-remove-list {
        background: #ffebee;
        color: var(--danger);
        border-color: #ffcdd2;
      }
      .btn-remove-list:hover {
        background: #ef9a9a;
        color: white;
      }
      .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: 0.2s;
      }
      .btn-primary {
        background-color: var(--primary);
        color: white;
      }
      .btn-secondary {
        background-color: #e0e0e0;
        color: #333;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
      }
      .btn-outline:hover {
        background: #e3f2fd;
      }
      .btn-sm {
        padding: 4px 8px;
        font-size: 0.7rem;
        margin-left: 2px;
      }
      .actions {
        margin: 30px 0;
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .output-section {
        position: relative;
        margin-bottom: 50px;
      }
      #resultArea {
        width: 100%;
        height: 120px;
        padding: 15px;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-family: monospace;
        font-size: 1rem;
        background: #fff;
      }
      .char-count {
        text-align: right;
        font-size: 0.9rem;
        margin-top: 5px;
        color: var(--text-light);
      }
      .limit-exceeded {
        color: var(--danger);
        font-weight: bold;
      }
      #libraryContainer {
        background: #fff;
        border-radius: var(--radius);
        padding: 20px;
        box-shadow: var(--shadow);
        margin-bottom: 50px;
      }
      .library-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 1rem;
      }

      .library-table th,
      .library-table td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .library-table thead th {
        color: var(--text-light);
      }
      .library-actions {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        display: none;
        justify-content: center;
        align-items: center;
      }
      .modal {
        background: white;
        padding: 25px;
        border-radius: 8px;
        width: 500px;
        max-width: 95%;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        max-height: 90vh;
      }
      .modal h3 {
        margin-top: 0;
        margin-bottom: 15px;
      }
      .modal input,
      .modal select {
        width: 100%;
        padding: 8px;
        margin: 10px 0;
        box-sizing: border-box;
      }
      .modal textarea {
        height: 200px;
        margin-bottom: 15px;
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        resize: vertical;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      .minus-section .card {
        border-top: 3px solid var(--danger);
      }
      .minus-section .card-header {
        background: #fff0f0;
        color: var(--danger);
      }
      .exact-card {
        border-top: 3px solid var(--success);
      }
      .exact-card .card-header {
        background: #e8f5e9;
        color: var(--success);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div>
          <h1>–í–æ—Ä–¥—Å—Ç–∞—Ç –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä PRO</h1>
          <div class="description">–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–ª–æ–≥–∞</div>
        </div>
        <div class="project-controls">
          <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ -->
          <span id="currentProjectLabel"></span>

          <!-- –ö–Ω–æ–ø–∫–∞ –û–ë–ù–û–í–ò–¢–¨ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
          <button id="updateProjectBtn" class="btn btn-primary" style="display: none; background-color: var(--success)" title="–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ–µ–∫—Ç">‚Üª –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>

          <button id="saveProjectBtn" class="btn btn-outline" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫...</button>
          <button id="loadProjectBtn" class="btn btn-outline" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>

          <div class="json-controls">
            <button id="exportJsonBtn" class="btn btn-secondary" title="–°–∫–∞—á–∞—Ç—å –±–∞–∑—É —Å–ø–∏—Å–∫–æ–≤ –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤">‚¨á JSON</button>
            <input type="file" id="importJsonInput" style="display: none" accept=".json" />
            <button id="importJsonBtn" class="btn btn-secondary" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –∏–∑ —Ñ–∞–π–ª–∞">‚¨Ü JSON</button>
          </div>
        </div>
      </header>

      <!-- –†–ê–ó–î–ï–õ 1: –°–ï–ú–ê–ù–¢–ò–ö–ê -->
      <div class="section-title">
        <span>1. –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä —Ñ—Ä–∞–∑</span>
        <button id="addListBtn" class="btn-add" title="–î–æ–±–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">+</button>
      </div>

      <div class="grid-wrapper" id="semanticsContainer">
        <div class="card exact-card">
          <div class="card-header">
            <div class="card-header-top">
              <span class="card-title">–¢–æ—á–Ω—ã–µ —Ñ—Ä–∞–∑—ã</span>
              <div class="card-tools">
                <select class="list-select" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">
                  <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option>
                </select>
                <button class="btn-icon btn-save-list" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É">üíæ</button>
              </div>
            </div>
            <div class="card-hint">–ü—Ä–∏–º–µ—Ä: "–∫—É–ø–∏—Ç—å –∞–≤—Ç–æ"</div>
          </div>
          <div class="card-body">
            <textarea id="exactPhrasesInput" class="word-input save-target" data-save-id="exact-0"></textarea>
          </div>
          <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
        </div>
        <div id="dynamicListsWrapper" style="display: flex; gap: 20px"></div>
      </div>

      <!-- –†–ê–ó–î–ï–õ 2: –ú–ò–ù–£–° –°–õ–û–í–ê -->
      <div class="section-title" style="color: var(--danger); border-color: var(--danger)">2. –í—Å–µ –º–∏–Ω—É—Å—ã</div>

      <div class="grid-wrapper minus-section">
        <!-- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ -->
        <div class="card">
          <div class="card-header">
            <div class="card-header-top">
              <span class="card-title">–ü—Ä–æ—Å—Ç—ã–µ –º–∏–Ω—É—Å—ã</span>
              <div class="card-tools">
                <select class="list-select">
                  <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option></select
                ><button class="btn-icon btn-save-list">üíæ</button>
              </div>
            </div>
            <div class="card-hint">–†–µ–∑—É–ª—å—Ç–∞—Ç: -—Å–ª–æ–≤–æ</div>
          </div>
          <div class="card-body"><textarea id="minusSimple" class="word-input save-target" data-save-id="minus-1"></textarea></div>
          <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-header-top">
              <span class="card-title">–°—Ç—Ä–æ–≥–∏–µ —Å–ª–æ–≤–∞ (!)</span>
              <div class="card-tools">
                <select class="list-select">
                  <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option></select
                ><button class="btn-icon btn-save-list">üíæ</button>
              </div>
            </div>
            <div class="card-hint">–†–µ–∑—É–ª—å—Ç–∞—Ç: -!—Å–ª–æ–≤–æ</div>
          </div>
          <div class="card-body"><textarea id="minusStrictWord" class="word-input save-target" data-save-id="minus-2"></textarea></div>
          <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-header-top">
              <span class="card-title">–§—Ä–∞–∑—ã ""</span>
              <div class="card-tools">
                <select class="list-select">
                  <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option></select
                ><button class="btn-icon btn-save-list">üíæ</button>
              </div>
            </div>
            <div class="card-hint">–†–µ–∑—É–ª—å—Ç–∞—Ç: -"!—Ñ—Ä–∞–∑–∞"</div>
          </div>
          <div class="card-body"><textarea id="minusStrictPhraseQuotes" class="word-input save-target" data-save-id="minus-3"></textarea></div>
          <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-header-top">
              <span class="card-title">–§—Ä–∞–∑—ã []</span>
              <div class="card-tools">
                <select class="list-select">
                  <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option></select
                ><button class="btn-icon btn-save-list">üíæ</button>
              </div>
            </div>
            <div class="card-hint">–†–µ–∑—É–ª—å—Ç–∞—Ç: -[!—Ñ—Ä–∞–∑–∞]</div>
          </div>
          <div class="card-body"><textarea id="minusStrictPhraseBrackets" class="word-input save-target" data-save-id="minus-4"></textarea></div>
          <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
        </div>
      </div>

      <div class="actions">
        <button id="generateBtn" class="btn btn-primary" style="padding: 12px 30px; font-size: 16px">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>
        <button id="clearBtn" class="btn btn-secondary">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è</button>
      </div>

      <div class="output-section">
        <textarea id="resultArea" readonly placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –≥–æ—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..."></textarea>
        <div style="display: flex; justify-content: space-between; margin-top: 5px">
          <button id="copyBtn" class="btn btn-primary" style="background: var(--success)">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
          <div class="char-count">–°–∏–º–≤–æ–ª–æ–≤: <span id="charCount">0</span></div>
        </div>
      </div>

      <div class="section-title">
        <span>3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ (–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞)</span>
      </div>
      <div id="libraryContainer">
        <table class="library-table">
          <thead>
            <tr>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞</th>
              <th width="100">–°—Ç—Ä–æ–∫</th>
              <th width="150" style="text-align: right">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="libraryTableBody"></tbody>
        </table>
        <div id="emptyLibraryMsg" style="text-align: center; color: #999; padding: 20px">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤.</div>
      </div>
    </div>

    <!-- MODALS -->
    <div id="saveListModal" class="modal-overlay">
      <div class="modal" style="height: auto">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π —Å–ø–∏—Å–æ–∫</h3>
        <p>–ù–∞–∑–≤–∞–Ω–∏–µ:</p>
        <input type="text" id="saveListNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ì–æ—Ä–æ–¥–∞ –ú–û" />
        <div class="modal-buttons">
          <button class="btn btn-secondary modal-close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" id="confirmSaveListBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="editListModal" class="modal-overlay">
      <div class="modal">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞</h3>
        <input type="text" id="editListNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞" />
        <textarea id="editListContentInput" placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø–∏—Å–∫–∞..."></textarea>
        <div class="modal-buttons">
          <button class="btn btn-secondary modal-close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" id="confirmEditListBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </div>
      </div>
    </div>

    <div id="saveProjectModal" class="modal-overlay">
      <div class="modal" style="height: auto">
        <h3>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
        <p>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞:</p>
        <input type="text" id="saveProjectNameInput" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–≤—Ç–æ—à–∫–æ–ª–∞ 2025" />
        <div class="modal-buttons">
          <button class="btn btn-secondary modal-close">–û—Ç–º–µ–Ω–∞</button>
          <button class="btn btn-primary" id="confirmSaveProjectBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <div id="loadProjectModal" class="modal-overlay">
      <div class="modal" style="width: 650px; height: auto; max-height: 85vh">
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏</h3>
        <div style="overflow-y: auto; max-height: 400px; border: 1px solid #eee; border-radius: 4px">
          <table class="library-table" style="margin: 0">
            <thead style="position: sticky; top: 0; background: #fff; z-index: 1">
              <tr>
                <th style="padding-left: 10px">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</th>
                <th width="100">–î–∞—Ç–∞</th>
                <th width="120" style="text-align: right; padding-right: 10px">–î–µ–π—Å—Ç–≤–∏—è</th>
              </tr>
            </thead>
            <tbody id="projectsTableBody"></tbody>
          </table>
          <div id="emptyProjectsMsg" style="text-align: center; color: #999; padding: 20px; display: none">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤.</div>
        </div>
        <div class="modal-buttons"><button class="btn btn-secondary modal-close">–ó–∞–∫—Ä—ã—Ç—å</button></div>
      </div>
    </div>

    <template id="listTemplate">
      <div class="card dynamic-list">
        <div class="card-header">
          <div class="card-header-top">
            <span class="card-title">–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤ ‚Ññ<span class="list-number"></span></span>
            <div class="card-tools">
              <select class="list-select" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫">
                <option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option>
              </select>
              <button class="btn-icon btn-save-list" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">üíæ</button>
              <button class="btn-icon btn-remove-list" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
            </div>
          </div>
          <div class="card-hint">–†–µ–∑—É–ª—å—Ç–∞—Ç: (—Å–ª–æ–≤–æ|—Å–ª–æ–≤–æ)</div>
        </div>
        <div class="card-body"><textarea class="word-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–∞..."></textarea></div>
        <div class="card-footer"><span class="count">0</span> —Å—Ç—Ä–æ–∫</div>
      </div>
    </template>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- State ---
        let appData = { savedLists: [], savedProjects: [] };
        let activeTextareaForSave = null;
        let editingListId = null;

        // –ù–æ–≤–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ID –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
        let currentOpenProjectId = null;

        // --- Init ---
        loadGlobalData();
        restoreCurrentState();
        initEventListeners();
        renderLibrary();
        updateAllDropdowns();

        // --- Core Logic ---
        function addDynamicList(content = "") {
          const tmpl = document.getElementById("listTemplate");
          const clone = tmpl.content.cloneNode(true);
          const card = clone.querySelector(".card");
          const textarea = card.querySelector("textarea");
          textarea.value = content;
          textarea.addEventListener("input", () => {
            updateCounter(textarea);
            saveCurrentState();
          });
          card.querySelector(".btn-remove-list").addEventListener("click", () => {
            if (confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É?")) {
              card.remove();
              renumberLists();
              saveCurrentState();
            }
          });
          bindCardActions(card, textarea);
          document.getElementById("dynamicListsWrapper").appendChild(card);
          renumberLists();
          updateCounter(textarea);
        }
        function renumberLists() {
          document.querySelectorAll(".dynamic-list").forEach((c, i) => {
            c.querySelector(".list-number").textContent = i + 1;
            const ta = c.querySelector("textarea");
            ta.dataset.saveId = `dynamic-${i}`;
            ta.classList.add("save-target");
          });
        }
        function bindCardActions(card, textarea) {
          card.querySelector(".btn-save-list").addEventListener("click", () => openSaveListModal(textarea));
          const select = card.querySelector(".list-select");
          populateDropdown(select);
          select.addEventListener("change", (e) => {
            const listId = e.target.value;
            if (!listId) return;
            const list = appData.savedLists.find((l) => l.id === listId);
            if (list) {
              textarea.value = list.content;
              updateCounter(textarea);
              saveCurrentState();
              select.value = "";
            }
          });
        }
        function populateDropdown(selectElement) {
          selectElement.innerHTML = '<option value="">–í—Å—Ç–∞–≤–∏—Ç—å...</option>';
          appData.savedLists.forEach((l) => {
            const opt = document.createElement("option");
            opt.value = l.id;
            opt.textContent = l.name;
            selectElement.appendChild(opt);
          });
          selectElement.value = "";
        }
        function updateAllDropdowns() {
          document.querySelectorAll(".list-select").forEach((sel) => populateDropdown(sel));
        }

        function saveCurrentState() {
          const state = {};
          document.querySelectorAll(".save-target").forEach((el) => {
            if (el.dataset.saveId) state[el.dataset.saveId] = el.value;
          });
          state.dynamicCount = document.querySelectorAll(".dynamic-list").length;
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–∞–∫–∂–µ ID —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ F5 –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" –Ω–µ –ø—Ä–æ–ø–∞–ª–∞
          state.currentOpenProjectId = currentOpenProjectId;
          localStorage.setItem("wsCombiner_CurrentState", JSON.stringify(state));
        }
        function restoreCurrentState() {
          const raw = localStorage.getItem("wsCombiner_CurrentState");
          if (!raw) {
            addDynamicList();
            addDynamicList();
            return;
          }
          const state = JSON.parse(raw);
          const count = state.dynamicCount || 2;
          for (let i = 0; i < count; i++) addDynamicList();

          // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ID –ø—Ä–æ–µ–∫—Ç–∞
          if (state.currentOpenProjectId) {
            currentOpenProjectId = state.currentOpenProjectId;
            const proj = appData.savedProjects.find((p) => p.id === currentOpenProjectId);
            if (proj) activateUpdateMode(proj.name);
          }

          setTimeout(() => {
            document.querySelectorAll(".save-target").forEach((el) => {
              if (state[el.dataset.saveId] !== undefined) {
                el.value = state[el.dataset.saveId];
                updateCounter(el);
              }
            });
            renumberLists();
          }, 0);
        }

        // --- Library Logic ---
        function openSaveListModal(textarea) {
          if (!textarea.value.trim()) return alert("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç!");
          activeTextareaForSave = textarea;
          document.getElementById("saveListModal").style.display = "flex";
          document.getElementById("saveListNameInput").value = "";
          document.getElementById("saveListNameInput").focus();
        }
        function saveNewList() {
          const name = document.getElementById("saveListNameInput").value.trim();
          if (!name) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");
          appData.savedLists.push({ id: generateId(), name: name, content: activeTextareaForSave.value });
          saveGlobalData();
          renderLibrary();
          updateAllDropdowns();
          closeModals();
        }
        function openEditListModal(id) {
          const list = appData.savedLists.find((l) => l.id === id);
          if (!list) return;
          editingListId = id;
          document.getElementById("editListNameInput").value = list.name;
          document.getElementById("editListContentInput").value = list.content;
          document.getElementById("editListModal").style.display = "flex";
        }
        function saveEditedList() {
          const name = document.getElementById("editListNameInput").value.trim();
          const content = document.getElementById("editListContentInput").value;
          const idx = appData.savedLists.findIndex((l) => l.id === editingListId);
          if (idx !== -1) {
            appData.savedLists[idx].name = name;
            appData.savedLists[idx].content = content;
            saveGlobalData();
            renderLibrary();
            updateAllDropdowns();
            closeModals();
          }
        }
        function renderLibrary() {
          const tbody = document.getElementById("libraryTableBody");
          tbody.innerHTML = "";
          const msg = document.getElementById("emptyLibraryMsg");
          if (appData.savedLists.length === 0) {
            msg.style.display = "block";
            return;
          }
          msg.style.display = "none";
          appData.savedLists.forEach((list) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td><b>${list.name}</b></td><td>${cleanLines(list.content).length}</td><td class="library-actions"><button class="btn btn-secondary btn-sm" onclick="copyToClip('${
              list.id
            }')">üìã</button><button class="btn btn-primary btn-sm" onclick="editList('${list.id}')">‚úèÔ∏è</button><button class="btn btn-secondary btn-sm" style="color:red;" onclick="deleteList('${
              list.id
            }')">√ó</button></td>`;
            tbody.appendChild(tr);
          });
        }

        // --- Project Logic ---
        function activateUpdateMode(projectName) {
          const lbl = document.getElementById("currentProjectLabel");
          const btn = document.getElementById("updateProjectBtn");
          lbl.textContent = `–¢–µ–∫—É—â–∏–π –ø—Ä–æ–µ–∫—Ç: ${projectName}`;
          lbl.style.display = "inline-block";
          btn.style.display = "inline-block";
        }

        function openSaveProjectModal() {
          document.getElementById("saveProjectModal").style.display = "flex";
        }

        // –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫..." (–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç)
        function saveProjectAsNew() {
          const name = document.getElementById("saveProjectNameInput").value.trim();
          if (!name) return;
          const currentData = {};
          document.querySelectorAll(".save-target").forEach((el) => {
            if (el.dataset.saveId) currentData[el.dataset.saveId] = el.value;
          });

          const project = {
            id: generateId(),
            name: name,
            dynamicCount: document.querySelectorAll(".dynamic-list").length,
            data: currentData,
            timestamp: new Date().toISOString(),
          };

          // –ï—Å–ª–∏ –∏–º—è –∑–∞–Ω—è—Ç–æ
          const existIdx = appData.savedProjects.findIndex((p) => p.name.toLowerCase() === name.toLowerCase());
          if (existIdx >= 0) {
            if (!confirm(`–ü—Ä–æ–µ–∫—Ç "${name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å –µ–≥–æ?`)) return;
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –ø–æ –∏–º–µ–Ω–∏, —Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º ID
            project.id = appData.savedProjects[existIdx].id;
            appData.savedProjects[existIdx] = project;
          } else {
            appData.savedProjects.push(project);
          }

          saveGlobalData();
          closeModals();
          alert("–ü—Ä–æ–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");

          // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ä–µ–∂–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
          currentOpenProjectId = project.id;
          activateUpdateMode(project.name);
          saveCurrentState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤ —Å—Ç–µ–π—Ç
        }

        // –ö–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç"
        function updateCurrentProject() {
          if (!currentOpenProjectId) return;

          const idx = appData.savedProjects.findIndex((p) => p.id === currentOpenProjectId);
          if (idx === -1) {
            alert("–û—à–∏–±–∫–∞: –∏—Å—Ö–æ–¥–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω (–≤–æ–∑–º–æ–∂–Ω–æ –±—ã–ª —É–¥–∞–ª–µ–Ω). –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∫–∞–∫ –Ω–æ–≤—ã–π.");
            return;
          }

          const currentData = {};
          document.querySelectorAll(".save-target").forEach((el) => {
            if (el.dataset.saveId) currentData[el.dataset.saveId] = el.value;
          });

          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ, —Å–æ—Ö—Ä–∞–Ω—è—è ID –∏ –ò–º—è
          appData.savedProjects[idx].data = currentData;
          appData.savedProjects[idx].dynamicCount = document.querySelectorAll(".dynamic-list").length;
          appData.savedProjects[idx].timestamp = new Date().toISOString();

          saveGlobalData();
          alert(`–ü—Ä–æ–µ–∫—Ç "${appData.savedProjects[idx].name}" —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!`);
        }

        function openLoadProjectModal() {
          renderProjectsTable();
          document.getElementById("loadProjectModal").style.display = "flex";
        }

        function renderProjectsTable() {
          const tbody = document.getElementById("projectsTableBody");
          tbody.innerHTML = "";
          const msg = document.getElementById("emptyProjectsMsg");
          if (appData.savedProjects.length === 0) {
            msg.style.display = "block";
            return;
          }
          msg.style.display = "none";
          const sortedProjects = [...appData.savedProjects].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          sortedProjects.forEach((p) => {
            const dateStr = new Date(p.timestamp).toLocaleDateString();
            const tr = document.createElement("tr");
            tr.innerHTML = `<td style="padding-left: 10px;"><b>${p.name}</b></td><td style="font-size: 12px; color: #666;">${dateStr}</td><td style="text-align: right; padding-right: 10px;"><button class="btn btn-primary btn-sm" onclick="loadProject('${p.id}')">üìÇ</button><button class="btn btn-secondary btn-sm" style="color:red;" onclick="deleteProject('${p.id}')">üóëÔ∏è</button></td>`;
            tbody.appendChild(tr);
          });
        }

        // --- Helpers ---
        function generateId() {
          return Math.random().toString(36).substr(2, 9);
        }
        function cleanLines(text) {
          return text
            ? [
                ...new Set(
                  text
                    .split("\n")
                    .map((l) => l.trim())
                    .filter((l) => l !== "")
                ),
              ]
            : [];
        }
        function updateCounter(ta) {
          const c = ta.closest(".card").querySelector(".count");
          if (c) c.textContent = cleanLines(ta.value).length;
        }
        function saveGlobalData() {
          localStorage.setItem("wsCombiner_GlobalDB", JSON.stringify(appData));
        }
        function loadGlobalData() {
          const raw = localStorage.getItem("wsCombiner_GlobalDB");
          if (raw) appData = JSON.parse(raw);
        }

        // --- Expose ---
        window.editList = openEditListModal;
        window.deleteList = (id) => {
          if (confirm("–£–¥–∞–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫?")) {
            appData.savedLists = appData.savedLists.filter((l) => l.id !== id);
            saveGlobalData();
            renderLibrary();
            updateAllDropdowns();
          }
        };
        window.copyToClip = (id) => {
          const list = appData.savedLists.find((l) => l.id === id);
          if (list) {
            navigator.clipboard.writeText(list.content);
            alert("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
          }
        };
        window.loadProject = (id) => {
          const project = appData.savedProjects.find((p) => p.id === id);
          if (!project) return;
          if (!confirm(`–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${project.name}"?`)) return;

          document.getElementById("dynamicListsWrapper").innerHTML = "";
          for (let i = 0; i < project.dynamicCount; i++) addDynamicList();

          setTimeout(() => {
            document.querySelectorAll(".save-target").forEach((el) => {
              if (project.data[el.dataset.saveId] !== undefined) {
                el.value = project.data[el.dataset.saveId];
                updateCounter(el);
              } else {
                el.value = "";
                updateCounter(el);
              }
            });
            renumberLists();

            // Set Update Mode
            currentOpenProjectId = project.id;
            activateUpdateMode(project.name);
            saveCurrentState();
          }, 0);
          closeModals();
        };
        window.deleteProject = (id) => {
          if (confirm("–ë–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) {
            appData.savedProjects = appData.savedProjects.filter((p) => p.id !== id);
            saveGlobalData();
            renderProjectsTable();
          }
        };

        // --- Events ---
        function initEventListeners() {
          document.getElementById("addListBtn").addEventListener("click", () => addDynamicList());
          document.getElementById("generateBtn").addEventListener("click", generateQuery);
          document.getElementById("clearBtn").addEventListener("click", () => {
            if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ?")) {
              document.querySelectorAll("textarea").forEach((t) => {
                t.value = "";
                updateCounter(t);
              });
              // –°–±—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ
              currentOpenProjectId = null;
              document.getElementById("currentProjectLabel").style.display = "none";
              document.getElementById("updateProjectBtn").style.display = "none";
              saveCurrentState();
            }
          });
          document.getElementById("copyBtn").addEventListener("click", () => {
            document.getElementById("resultArea").select();
            document.execCommand("copy");
          });

          document.getElementById("saveProjectBtn").addEventListener("click", openSaveProjectModal);
          document.getElementById("updateProjectBtn").addEventListener("click", updateCurrentProject);
          document.getElementById("loadProjectBtn").addEventListener("click", openLoadProjectModal);

          document.getElementById("exportJsonBtn").addEventListener("click", () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const a = document.createElement("a");
            a.href = dataStr;
            a.download = "wordstat_combiner.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
          });
          document.getElementById("importJsonBtn").addEventListener("click", () => document.getElementById("importJsonInput").click());
          document.getElementById("importJsonInput").addEventListener("change", (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const r = new FileReader();
            r.onload = (ev) => {
              try {
                const d = JSON.parse(ev.target.result);
                if (d.savedLists) {
                  appData = d;
                  saveGlobalData();
                  renderLibrary();
                  updateAllDropdowns();
                  alert("–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
                }
              } catch (err) {
                alert("–û—à–∏–±–∫–∞ —Ñ–∞–π–ª–∞");
              }
            };
            r.readAsText(f);
          });

          document.querySelectorAll(".minus-section .card, .exact-card").forEach((card) => {
            const ta = card.querySelector("textarea");
            bindCardActions(card, ta);
            ta.addEventListener("input", () => {
              updateCounter(ta);
              saveCurrentState();
            });
          });

          document.querySelectorAll(".modal-close").forEach((b) => b.addEventListener("click", closeModals));
          document.getElementById("confirmSaveListBtn").addEventListener("click", saveNewList);
          document.getElementById("confirmEditListBtn").addEventListener("click", saveEditedList);
          document.getElementById("confirmSaveProjectBtn").addEventListener("click", saveProjectAsNew);
        }

        function closeModals() {
          document.querySelectorAll(".modal-overlay").forEach((m) => (m.style.display = "none"));
        }

        // --- Generator ---
        function generateQuery() {
          const parts = [];
          const exact = cleanLines(document.getElementById("exactPhrasesInput").value);
          if (exact.length) parts.push(`(${exact.map((l) => (l.includes('"') ? l : `"${l}"`)).join("|")})`);
          document.querySelectorAll("#dynamicListsWrapper textarea").forEach((ta) => {
            const l = cleanLines(ta.value);
            if (l.length) parts.push(`(${l.join("|")})`);
          });
          const minus = [];
          const addToMinus = (id, f) => {
            cleanLines(document.getElementById(id).value).forEach((line) => {
              if (f === "simple") line.split(/\s+/).forEach((w) => minus.push(`-${w}`));
              if (f === "word") line.split(/\s+/).forEach((w) => minus.push(`-!${w}`));
              if (f === "quote")
                minus.push(
                  `-"${line
                    .split(/\s+/)
                    .map((w) => (w.startsWith("!") ? w : `!${w}`))
                    .join(" ")}"`
                );
              if (f === "bracket")
                minus.push(
                  `-[${line
                    .split(/\s+/)
                    .map((w) => (w.startsWith("!") ? w : `!${w}`))
                    .join(" ")}]`
                );
            });
          };
          addToMinus("minusSimple", "simple");
          addToMinus("minusStrictWord", "word");
          addToMinus("minusStrictPhraseQuotes", "quote");
          addToMinus("minusStrictPhraseBrackets", "bracket");
          const res = (parts.join(" ") + " " + minus.join(" ")).trim();
          document.getElementById("resultArea").value = res;
          const len = res.length;
          document.getElementById("charCount").textContent = len;
          document.getElementById("charCount").classList.toggle("limit-exceeded", len > 4096);
        }
      });
    </script>
  </body>
</html>
